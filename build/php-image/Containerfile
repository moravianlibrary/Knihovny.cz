FROM docker.io/php:8.0-apache-bullseye
#FROM docker.io/php:7.4-apache-bullseye
ARG ADD_EXTRA_PACKAGES=""

LABEL maintainer="mzk.cz"
USER root

## Configure Apache
#RUN a2enmod rewrite \
#    && sed -i 's!/var/www/html!/var/www/public!g' /etc/apache2/sites-available/000-default.conf \
#    && mv /var/www/html /var/www/public

# add apache2 extensions
RUN \
    apt update && \
    apt install -y libapache2-mod-shib && \
    apt clean

## Install libraries and extension
RUN apt install -y git zlib1g-dev libzip-dev libicu-dev libonig-dev \
    && docker-php-ext-install zip \
    && docker-php-ext-configure intl \
    && docker-php-ext-install intl \
    && docker-php-ext-install mbstring
## more libraries!

# add basic productivity tools
RUN apt update && apt-get install -y \
        bash-completion \
        coreutils \
        curl \
        dnsutils \
        git \
        htop \
        iputils-ping \
        iputils-tracepath \
        libapache2-mod-rpaf \
        libapache2-mod-shib \
        mc \
        mlocate \
        default-mysql-client \
        net-tools \
        ssh \
        vim \
        locales \
        nodejs \
        npm \
        ${ADD_EXTRA_PACKAGES} \
    && apt-get clean \
    && apt-get autoremove -y


# RUN docker-php-ext-install apcu  ## this is deprecated in PHP 8.0
RUN docker-php-ext-install  opcache
RUN \
    apt install -y libpng-dev && \
    docker-php-ext-install gd
## RUN docker-php-ext-install ldap ## this is not needed in VUFind
RUN docker-php-ext-install mysqli pdo_mysql
RUN \
    apt install -y libxml2-dev libxslt1-dev && \
   docker-php-ext-install soap xml xsl
RUN  \
   pecl install xdebug \
    && docker-php-ext-enable xdebug
RUN \
    pecl install redis \
    && docker-php-ext-enable redis

RUN a2enmod headers rewrite

ADD docker/etc /etc
ADD docker/bin/container-entrypoint.sh /container-entrypoint.sh
ADD docker/initscripts/bootstrap-shibboleth2.sh /onstart.d/000-bootstrap-shibboleth2.sh
RUN chmod ugo+x /container-entrypoint.sh /onstart.d/*.sh

ADD https://github.com/a8m/envsubst/releases/download/v1.2.0/envsubst-Linux-x86_64 /usr/bin/envsubst.a8m
RUN \
    chmod a+x /usr/bin/envsubst.a8m

RUN \
  groupadd --gid 1000 vufind && \
  useradd --create-home --shell /bin/bash --uid 1000 --gid 1000 vufind

ENTRYPOINT [ "/container-entrypoint.sh" ]
